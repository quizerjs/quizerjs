# RFC 0021: 韧性 DSL 转换与宽松验证详细设计规范

## 1. 核心目标：坚持 WYSIWYG 黄金准则

**WYSIWYG (所见即所得)** 意味着：当用户在编辑器里输入或操作时，底层生成的 DSL 必须是该状态的“忠实镜像”。

- **不允许**: 因为某个字段没填就直接把整个块从 DSL 中抹除（这会导致用户辛辛苦苦写的其他部分也一起消失）。
- **不允许**: 在转换过程中，因为校验不通过就抛出错误导致程序崩溃或停止保存。
- **允许**: 过滤掉与“测验”业务完全无关的第三方插件块（例如用户在 QuizEditor 中意外插入了一个它不认识的广告位块），以保持 DSL 数据的纯净。

---

## 2. 详细技术方案说明 (Detailed Design)

为了避免“堆砌术语”，我们将具体描述转换器的物理行为。

### 2.1 转换器的“韧性”行为描述 (行为化解释)

所谓的“韧性转换”，在代码实现上表现为以下三个具体处理分支：

1. **空值补全 (Defaulting, NOT Inventing)**:
   在将 DSL 加载到编辑器时，如果某个测验块（如单选题）缺少了 `score` 字段，转换器不应报错，而是自动赋予它一个 `0` 或配置中的默认值。这保证了即使后端数据有瑕疵，前端依然能“渲染出来”给用户看。
2. **结构保全 (Structural Preservation)**:
   在保存数据时，如果用户新增了一个问题但还没填标题，`blockToDSL` 必须生成一个具有该 ID 的 Question 对象，并将标题设为空字符串 `""`。即使这个 DSL 看起来“不完整”，它也保全了用户“想要这里有一个问题”的意图。

3. **过滤与保留的关系**:
   - **属于测验的数据块**（Header, Paragraph, Quiz Block）：必须全量转换，严禁因内容为空而过滤。
   - **非测验相关的数据块**：如果在 Editor.js 中发现了不属于本系统定义的块类型，转换器可以选择将其“过滤”掉，不存入最终的 Quiz DSL 中，从而保证 DSL 的业务纯粹性。

### 2.2 “标识转换” (Round-trip) 的物理定义

这意味着 `DSL -> Editor -> DSL` 的循环必须达成：
**物理内容（字符串、选项、分值）在经过两次转换后，逻辑意义必须完全一致。**

我们将通过以下逻辑保证：

- 转换器不应在转换过程中进行任何类似 `trim()` 或“自动修正”操作，除非是格式标准化（如 HTML 转 Markdown）。
- 用户输入的每一个字符，其存放路径在 DSL 中必须是确定且唯一的。

### 2.3 验证逻辑的重构：从“阻塞”到“反馈”

目前的 `validateQuizDSL` 就像一个警察，看到违规就关掉电源（`throw Error`）。
**重构后**：

- 验证器变成一个“观察员”。它检查保存后的 DSL，如果发现某个问题没设正确答案，它会返回一个错误列表。
- `QuizEditor` 会接收这个列表，并在 UI 上（比如在题号旁边）打一个小红叉，但**不会阻止**保存操作，也不会让页面崩溃。

---

## 3. 测试计划详细描述 (Test Plan)

为了验证上述逻辑，我们将实施以下具体的“破坏性”测试：

1. **缺失字段鲁棒性测试**: 手动构造一个缺少 `options` 数组的单选题 DSL，验证调用 `load()` 后，编辑器是否能显示出一个“没有选项的问题”供用户补全，而不是直接崩溃。
2. **空内容保全测试**: 在编辑器中创建 3 个空章节和 5 个空问题，点击保存，验证生成的 JSON 中是否包含完整的 3 个 section 和 5 个 question 结构。
3. **多语言占位一致性**:
   - 加载 DSL：使用中文配置时，空标题显示“未命名测验”。
   - 切换配置：切换到英文后，同一个空标题应显示 "Untitled Quiz"。
   - 物理断言：此时保存 DSL，其 `title` 字段在 JSON 中必须保持为原始值（或 `""`），证明 UI 的占位符没有污染真实数据。

---

## 4. 实施不变量 (Invariants)

1. **核心库中绝对不存在硬编码的自然语言字符串**。
2. **数据流不可中断**：除非出现无法解析的语法错误（无效 JSON），否则无论数据多烂，转换器必须产出结果。
